// Your initial setup
var csbca22 = ee.FeatureCollection("projects/nass-csb/assets/csb1522/CSBCA1522");
var california_bound = ee.FeatureCollection('TIGER/2016/States')
            .filter(ee.Filter.eq('NAME', 'California'));
var cdl = ee.ImageCollection('USDA/NASS/CDL')
                  .filter(ee.Filter.date('2016-01-01', '2016-10-02'))
                  .filterBounds(california_bound)
                  .first();

// Filter for strawberry fields
var strawberry_layer_csbca22 = csbca22.filter(ee.Filter.eq('CROP16', 'Strawberries'));

// Visualization Parameters
var visParams = {
  color: 'black',
  fillColor: 'ff0000' // Red fill color
};

// Adding layers to the map
Map.addLayer(strawberry_layer_csbca22, visParams, "Strawberry Fields");

// Mask the CDL image to keep only strawberry classified areas
var cropLandcover = cdl.select('cropland')
// Create a mask where the cropland is equal to 211 (strawberries)
var strawberriesMask = cropLandcover.eq(221);
// Apply the mask to the dataset
var strawberries = cropLandcover.updateMask(strawberriesMask);


// Add masked CDL to the map
Map.addLayer(strawberries, {}, 'CDL Strawberry Areas');

var vectorStrawberryFields = strawberries.reduceToVectors({
  geometry: california_bound.geometry(),
  scale: 30, // Adjust the scale based on your data's resolution
  maxPixels: 1e9
});
// Process each strawberry field

var strawberry_geom = vectorStrawberryFields.geometry();

var majority_vote_strawberies = strawberry_layer_csbca22.map(function(feature) {
  return feature.intersection(strawberry_geom, 1);
});

var state_outline = Map.addLayer(majority_vote_strawberies, visParams, "majority vote") 

print(majority_vote_strawberies.first())

Export.table.toAsset({
  collection: majority_vote_strawberies,
  description: 'strawberry_fields_cdl_csba_intersect',
  assetId: 'users/kevinlc3/strawberry_fields_cdl_csba_intersect'
});
